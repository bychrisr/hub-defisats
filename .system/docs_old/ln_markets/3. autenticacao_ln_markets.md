# Autentica√ß√£o LN Markets API v2

## ‚ö†Ô∏è CR√çTICO: Codifica√ß√£o de Assinatura

### Problema Identificado
A autentica√ß√£o com a LN Markets API v2 estava falhando porque nossa implementa√ß√£o usava **base64** para codificar a assinatura HMAC, mas a API requer **hexadecimal**.

### Solu√ß√£o Implementada
```typescript
// ‚ùå INCORRETO - base64 (n√£o funciona)
const signature = crypto
  .createHmac('sha256', apiSecret)
  .update(message, 'utf8')
  .digest('base64');

// ‚úÖ CORRETO - hexadecimal (obrigat√≥rio)
const signature = crypto
  .createHmac('sha256', apiSecret)
  .update(message, 'utf8')
  .digest('hex');
```

## Por Que Esta Mudan√ßa √© Obrigat√≥ria

### 1. Especifica√ß√£o da API
A documenta√ß√£o oficial da LN Markets API v2 especifica claramente:
> "assinatura codificada em hexadecimal (`hex`) deve ser usada no header `LNM-ACCESS-SIGNATURE`"

### 2. Incompatibilidade Total
- **base64**: Retorna assinatura inv√°lida ‚Üí 401 Unauthorized
- **hexadecimal**: Retorna assinatura v√°lida ‚Üí 200 OK

### 3. N√£o Pode Ser Revertida
Esta mudan√ßa √© **permanente** e **obrigat√≥ria**. Reverter para base64 quebrar√° toda a autentica√ß√£o.

## Implementa√ß√£o Correta

### Headers Obrigat√≥rios
```typescript
const headers = {
  'LNM-ACCESS-KEY': apiKey,
  'LNM-ACCESS-SIGNATURE': signature, // HEXADECIMAL
  'LNM-ACCESS-PASSPHRASE': passphrase,
  'LNM-ACCESS-TIMESTAMP': timestamp
};
```

### Gera√ß√£o da Assinatura
```typescript
// 1. Construir string de assinatura
const message = timestamp + method + path + params;

// 2. Gerar HMAC SHA256
const signature = crypto
  .createHmac('sha256', apiSecret)
  .update(message, 'utf8')
  .digest('hex'); // ‚Üê HEXADECIMAL OBRIGAT√ìRIO

// 3. Adicionar aos headers
headers['LNM-ACCESS-SIGNATURE'] = signature;
```

## Valida√ß√£o da Implementa√ß√£o

### Teste de Autentica√ß√£o
```bash
# Deve retornar 200 OK (n√£o 401/404)
curl -H "Authorization: Bearer <token>" \
  http://localhost:13010/api/lnmarkets/user/positions
```

### Resposta Esperada
```json
{
  "success": true,
  "data": [] // Array vazio, n√£o objetos {}
}
```

## Arquivos Modificados

### Backend
- `backend/src/services/lnmarkets-api.service.ts`
  - Linha 137: `.digest('hex')` em vez de `.digest('base64')`

### Frontend
- `frontend/src/pages/Positions.tsx`
  - Valida√ß√£o de timestamps inv√°lidos
  - Filtragem de objetos vazios

### Roteamento
- `backend/src/index.ts`
  - Reordena√ß√£o de rotas para resolver conflitos

## Monitoramento

### Logs de Sucesso
```
üîê LN MARKETS AUTH - Assinatura gerada: a1b2c3d4e5f6...
‚úÖ LN MARKETS POSITIONS - User positions retrieved successfully: []
```

### Logs de Erro (ANTES da corre√ß√£o)
```
‚ùå LN MARKETS ERROR - Request failed with status code 404
‚ö†Ô∏è LN MARKETS POSITIONS - Error getting user positions: Signature is not valid
```

## Conclus√£o

Esta corre√ß√£o √© **cr√≠tica** e **permanente**. A codifica√ß√£o hexadecimal √© obrigat√≥ria para a LN Markets API v2 e n√£o pode ser alterada sem quebrar toda a autentica√ß√£o.

**NUNCA** reverta para base64 - isso quebrar√° completamente a integra√ß√£o com a LN Markets.
